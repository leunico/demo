{extend name="common@public/base" /}
{block name="main"}
<div class="layui-body" id="main">
    <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
        <ul class="layui-tab-title">
            <li class="layui-this"><i class="fa fa-exclamation-circle">&nbsp;&nbsp;</i>项目概况</li>
        </ul>
        <div class="layui-tab-content" v-cloak>
            <div class="layui-tab-item layui-show">
                <div class="layui-anim layui-anim-upbit">
                    <div class="layui-block-item layui-elem-quote">

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{/block}

{block name="js"}
<script>
    layui.use(['layer', "jquery"], function(){
        var $ = layui.jquery,
            layer = layui.layer;

        var lists = new Vue({
            el: "#main",
            data: {
                project_id: "{$id}",
                items: {},
                items_search: {},
                keyword: ''
            },

            methods: {
                loadTeamList: function(){
                    layer.load();
                    $.ajax({
                        url : "/project/team/" + this.project_id,
                        type: "GET",
                        dataType: "json",
                        error:function(){layer.msg('请求列表失败!', {anim: 6})},
                        success:function(res){
                            layer.closeAll('loading');
                            if(res.code > 0){
                                lists.items = res.data;
                            }else{
                                layer.msg(res.msg, {anim: 6});
                            }
                        }
                    });
                },

                searchTeamList: function(e){
                    if(!this.keyword) {
                        layer.msg('请先输入关键字', {anim: 3});
                    }else{
                        $(".layui-form-select dl").show();
                        $.ajax({
                            url : "/project/team/search",
                            type: "POST",
                            data: {keyword: this.keyword, id: this.project_id},
                            dataType: "json",
                            error:function(){layer.msg('请求失败!', {anim: 6})},
                            success:function(res){
                                if(res.code > 0){
                                    lists.items_search = res.data.length ? res.data : false;
                                }else{
                                    layer.msg(res.msg, {anim: 6});
                                }
                            }
                        });
                    }
                    e.stopPropagation();
                },

                searchClick: function(e, user_id){
                    if(!$(e.currentTarget).hasClass('layui-disabled')){
                        $.ajax({
                            url : "/project/team/add",
                            type: "POST",
                            data: {user_id: user_id, project_id: this.project_id},
                            dataType: "json",
                            error:function(){layer.msg('请求失败!', {anim: 6})},
                            success:function(res){
                                if(res.code > 0){
                                    layer.msg('加入成功', {icon: 1});
                                    lists.loadTeamList();
                                }else{
                                    layer.msg(res.msg, {icon: 5});
                                    e.stopPropagation();
                                }
                            }
                        });
                    }
                },

                teamClick: function(type, id, name){
                    if(type == 1){
                        layer.prompt({
                            value: name,
                            title: '请输入备注名'
                        }, function(val, index){
                            $.ajax({
                                url: "/project/team/remark",
                                type: "PUT",
                                data: {name: val, id: id},
                                error:function(){layer.msg('请求失败!', {anim: 6})},
                                success:function(res){
                                    if(res.code > 0){
                                        layer.msg('修改成功', {icon: 1});
                                        lists.loadTeamList();
                                    }else{
                                        layer.msg(res.msg, {icon: 5});
                                    }
                                }
                            });
                            layer.close(index);
                        });
                    }else{
                        $.ajax({
                            url: "/project/team/set",
                            type: "PUT",
                            data: {type: type, id: id},
                            error:function(){layer.msg('请求失败!', {anim: 6})},
                            success:function(res){
                                if(res.code > 0){
                                    layer.msg('操作成功', {icon: 1});
                                    lists.loadTeamList();
                                }else{
                                    layer.msg(res.msg, {icon: 5});
                                }
                            }
                        });
                    }
                },

                menuOpen: function(e){
                    $(e.target).parent().next().show();
                    $(e.target).parent().next().mouseleave(function(){$(this).hide();});
                }
            },

            mounted: function(){
//                this.loadTeamList(1);
            }
        });
    });
</script>
{/block}